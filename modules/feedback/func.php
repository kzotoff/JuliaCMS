<?php // >class J_Feedback extends JuliaCMSModule {	// input processing for inserting to the message	private function prepare_to_insert($s) {		// replace specials		$s = htmlspecialchars($s);					// replace EOLs with BRs		$s = str_replace("\n", '<br />', $s);		return $s;	}	function requestParser($template) {				// при успешной отправке будем перенаправлять на страницу отчета об успешной отправке		$redirect_target = './service_feedback_ok';		$redirect_status = false;				if (((@$_POST['module'] == 'feedback') || (@$_GET['module'] == 'feedback')) && (($_POST['action']) == 'send')) {			// фильтруем вход			$input_filter = array(				'template' => array('filter' => FILTER_VALIDATE_REGEXP, 'options' => array('regexp' => REGEXP_ALIAS))			);						$p = filter_input_array(INPUT_POST, $input_filter);						// читаем шаблон сообщения, если не будет - шаблон/строку об ошибке			if (($text = @file_get_contents(__DIR__.'/template_'.$p['template'].'.html')) == '') {				($text = @file_get_contents(__DIR__.'/template_error_detected.html')) or ($text = 'error reading message template (code FEEDBACK/001)'.PHP_EOL.PHP_EOL.'details:'.PHP_EOL.'%POST%');				$redirect_target = './service_feedback_failed';			}			// заменяем шаблончики			foreach ($_POST as $index => $value) {				$text = str_replace('%'.$index.'%', $this->prepare_to_insert($value), $text);			}						// дополнительно весь POST сразу и реферер (нужны для обработки ошибок)			$text = str_replace('%POST%', '<pre>'.prepare_to_insert(print_r($_POST, 1)).'</pre>', $text);			$text = str_replace('%REFERER%', '<pre>'.prepare_to_insert($_SERVER['HTTP_REFERER']).'</pre>', $text);			// убираем неиспользованные шаблончики			$text = preg_replace('~%.*?%~', '', $text);						// попробуем вытащить title из шаблона, чтобы использовать как тему письма			if (preg_match('~<title>(.*?)</title>~smui', $text, $match)) {				$subject = $match[1];			} else {				$subject = $this->MODULE_CONFIG['default_subject'];			}						// определяем получателя - либо из формы, либо просто первого			$feedback_addresses = $this->MODULE_CONFIG['feedback_addresses'];			$recipient = isset($_POST['recipient']) && isset($feedback_addresses[$_POST['recipient']]) ? $feedback_addresses[$_POST['recipient']] : array_shift($feedback_addresses);			// отсылаем сообщение			$headers = 				 'From: '.$recipient.PHP_EOL				.'To: '.$recipient.PHP_EOL				.'Content-Type: text/html; charset=utf-8'				;			mail(				$recipient,				$subject,				$text,				$headers			);			$redirect_status = true;		}				if ($redirect_status) {			header('Location: '.$redirect_target);			terminate();		}		return $template;	}}?>