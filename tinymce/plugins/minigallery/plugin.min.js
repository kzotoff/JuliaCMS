tinymce.PluginManager.add('minigallery', function(editor, url) {
	
	function minigalleryShow() {
		editor.windowManager.open({
			title: 'Choose an image',
			file : url + '/main.php',
			width : 600,
			height: 450,
			inline : 1,
			buttons: [{
				text: 'Insert',
				classes:'widget btn primary first abs-layout-item',
				onclick: 'submit'
			},
			{
				text: 'Close',
				onclick: 'close'
			}],
			onsubmit: function(e) {
				
				// get ifreame contents
				var galleryHTML = $($('.mce-container-body').children('iframe')[0].contentDocument.body.innerHTML);
				var URL;
				// find first checked non-folder element, get its URL
				galleryHTML.find('.img_link').each(function() {
					if ($(this).closest('.album_item').children('.cb_div').children('.cb').val() == 'on') {
						URL = $(this).closest('.album_item').children('.caption_div').children('input').val();
					}
				});
				
				// add to text
				editor.insertContent('<img src="'+URL+'" alt="" />');
			}
		});
	}
	
	// Add a button that opens a window
	editor.addButton('minigallery', {
		tooltip: 'Choose image',
		icon : 'image',
		text: '',
		onclick: minigalleryShow
	});

	// Adds a menu item to the tools menu
	editor.addMenuItem('minigallery', {
		text: 'Choose image',
		icon : 'image',
		context: 'insert',
		onclick: minigalleryShow
	});
});